#!/usr/bin/env python3

# Copyright (C) 2015  Stefano Zacchiroli <zack@upsilon.cc>,
#                     Antoine R. Dumont <antoine.romain.dumont@gmail.com>
# See the AUTHORS file at the top-level directory of this distribution
# License: GNU General Public License version 3, or any later version
# See top-level LICENSE file for more information

import argparse
import logging
import os

from swh.backend import api
from swh.conf import reader
from swh.storage.objstorage import ObjStorage


# Default configuration file
DEFAULT_CONF_FILE = '~/.config/swh/back.ini'


# default configuration
DEFAULT_CONF = {
    'content_storage_dir' : ('string', '/tmp/swh-loader-git/content-storage'),
    'log_dir'             : ('string', '/tmp/swh-loader-git/log'),
    'db_url'              : ('string', 'dbname=softwareheritage-dev'),
    'folder_depth'        : ('int'   , 4),
    'debug'               : ('bool'  , None),
    'host'                : ('string', '127.0.0.1'),
    'port'                : ('int'   , 5000)
}


def parse_args():
    """Parse the configuration for the cli.
    """
    cli = argparse.ArgumentParser(
        description='Parse git repository objects to load them into DB.')
    cli.add_argument('--verbose', '-v', action='store_true',
                     help='Verbosity level in log file.')
    cli.add_argument('--config', '-c', help='configuration file path')

    args = cli.parse_args()

    return args


if __name__ == '__main__':
   args = parse_args()
   conf = reader.read(args.config or DEFAULT_CONF_FILE, DEFAULT_CONF)
   reader.prepare_folders(conf, 'log_dir', 'content_storage_dir')
   conf.update({
     'objstorage': ObjStorage(conf['content_storage_dir'],
                              conf['folder_depth'])
   })
   logging.basicConfig(filename=os.path.join(conf['log_dir'], 'back.log'),
                       level=logging.DEBUG if args.verbose else logging.INFO)
   api.run(conf)
